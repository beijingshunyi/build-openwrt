name: Build OpenWrt
run-name: ${{ inputs.device }}
on:
  workflow_dispatch:
    inputs:
      device:
        description: 设备型号
        required: true
        default: jdcloud_ax1800-pro
jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TERM: xterm-256color
      DEVICE: ${{ inputs.device }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget ncurses-term libtinfo5 libncursesw5-dev sed grep findutils
          sudo apt autoremove -y && sudo apt clean

      - name: Clone source
        run: |
          git clone --depth=1 --branch openwrt-23.05 https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          # 【策略调整】不添加 kenzo，只添加 small 源来获取 passwall
          echo "src-git small https://github.com/kenzok8/small.git;master" >> feeds.conf.default

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a

      - name: Install feeds and Remove Conflicts
        run: |
          cd openwrt
          
          # 1. 先删除 feeds 源码目录中的 nikki (fchomo 的依赖)
          # 必须在 install 之前删，否则 install 链接会建立依赖死锁
          echo "清理冲突源码..."
          rm -rf feeds/packages/net/nikki
          rm -rf feeds/luci/applications/luci-app-fchomo
          
          # 2. 执行安装，此时 nikki 已经没了，passwall 虽然依赖它，但会提示找不到而跳过
          echo "开始安装 Feeds..."
          ./scripts/feeds install -a --force-missing || true
          
          # 3. 再次清理 package 链接目录，防止遗留
          find package/feeds -name "nikki" -type d -exec rm -rf {} + || true
          find package/feeds -name "luci-app-fchomo" -type d -exec rm -rf {} + || true
          
          echo "清理完成，准备生成配置。"

      - name: Generate config
        run: |
          cd openwrt
          
          # 写入配置：注意这里明确禁用了官方带 bug 的包，选用了 small 源的 passwall
          # 如果 small 的 passwall 也不可用，编译阶段会报错，但至少能过了 defconfig
          echo -e "CONFIG_TARGET_ipq60xx=y\nCONFIG_TARGET_ipq60xx_generic=y\nCONFIG_TARGET_ipq60xx_generic_DEVICE_jdcloud_ax1800-pro=y\nCONFIG_LUCI=y\nCONFIG_LUCI_LANG_zh_Hans=y\nCONFIG_PACKAGE_curl=y\nCONFIG_PACKAGE_ipset=y\nCONFIG_PACKAGE_kmod-tun=y\nCONFIG_PACKAGE_iptables-mod-tproxy=y\nCONFIG_PACKAGE_v2ray-geodata=y\nCONFIG_PACKAGE_xray-core=y\nCONFIG_PACKAGE_hysteria2=y\nCONFIG_PACKAGE_sing-box=y\nCONFIG_PACKAGE_luci-app-passwall=y\nCONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y\nCONFIG_PACKAGE_wpad-openssl=y" > .config
          
          # 重新生成 .config
          make defconfig

      - name: Download dependencies
        run: |
          cd openwrt
          make download -j1 V=s

      - name: Compile firmware
        run: |
          cd openwrt
          make -j1 prepare V=s
          make -j$(($(nproc)-2)) V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-firmware
          path: openwrt/bin/targets/ipq60xx/generic/*.bin
          if-no-files-found: warn
