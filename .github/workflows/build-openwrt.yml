name: Build OpenWrt
run-name: ${{ inputs.device }}
on:
  workflow_dispatch:
    inputs:
      device:
        description: 设备型号
        required: true
        default: jdcloud_ax1800-pro
jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TERM: xterm-256color
      DEVICE: ${{ inputs.device }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget ncurses-term libtinfo5 libncursesw5-dev sed grep findutils
          sudo apt autoremove -y && sudo apt clean

      - name: Clone source
        run: |
          git clone --depth=1 --branch openwrt-23.05 https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          # 【注意】这里不再添加任何第三方源，彻底解决依赖冲突
          # 如果你需要第三方源的特定软件，必须确保该软件不引入冲突包
          # 官方源已包含 passwall，xray，sing-box 等

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a

      - name: Install feeds
        run: |
          cd openwrt
          ./scripts/feeds install -a --force-missing

      - name: Copy config
        run: |
          cd openwrt
          # 复制仓库根目录下的 .config 文件到源码目录
          cp ../.config .config
          # 直接生效配置，不运行 make defconfig 以防止引入未选择的依赖冲突
          # 如果官方源中确实没有某些包，这里会自动忽略，不会报错

      - name: Download dependencies
        run: |
          cd openwrt
          make download -j1 V=s

      - name: Compile firmware
        run: |
          cd openwrt
          make -j1 prepare V=s
          make -j$(($(nproc)-2)) V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-firmware
          path: openwrt/bin/targets/ipq60xx/generic/*.bin
          if-no-files-found: warn
