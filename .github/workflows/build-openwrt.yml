name: Build OpenWrt
run-name: Build ${{ inputs.device }}
on:
  workflow_dispatch:
    inputs:
      device:
        description: Device Model
        required: true
        default: jdcloud_ax1800-pro
jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TERM: xterm-256color
      DEVICE: ${{ inputs.device }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget ncurses-term libtinfo5 libncursesw5-dev sed grep findutils
          sudo apt autoremove -y && sudo apt clean

      - name: Clone source
        run: |
          # 使用 Lean 22.03 源
          git clone -b openwrt-22.03 https://github.com/Lienol/openwrt.git openwrt
          cd openwrt

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a

      - name: Install feeds
        run: |
          cd openwrt
          ./scripts/feeds install -a --force-missing

      - name: Patch Dependency Index (The Fix)
        run: |
          cd openwrt
          # 【关键修复】直接修改依赖索引文件，删除导致循环依赖的定义
          # 这是从代码层面绕过 make defconfig 的死锁检测
          if [ -f tmp/.config-package.in ]; then
            echo "正在修补依赖索引文件..."
            sed -i '/CONFIG_PACKAGE_luci-app-fchomo/,/^\s*$/d' tmp/.config-package.in || true
            sed -i '/CONFIG_PACKAGE_nikki/,/^\s*$/d' tmp/.config-package.in || true
            sed -i '/CONFIG_PACKAGE_luci-app-easymesh/,/^\s*$/d' tmp/.config-package.in || true
            echo "修补完成。"
          else
            echo "索引文件暂未生成，将在下一步生成后修补。"
          fi

      - name: Delete old config
        run: |
          cd openwrt
          rm -f .config
          rm -f ../.config

      - name: Generate config
        run: |
          cd openwrt
          # 手动写入配置，不运行 make defconfig，防止触发递归检测
          echo -e "CONFIG_TARGET_ipq60xx=y\nCONFIG_TARGET_ipq60xx_generic=y\nCONFIG_TARGET_ipq60xx_generic_DEVICE_jdcloud_ax1800-pro=y\nCONFIG_LUCI=y\nCONFIG_LUCI_LANG_zh_Hans=y\nCONFIG_PACKAGE_luci-app-passwall=y\nCONFIG_PACKAGE_wpad-openssl=y" > .config
          
          # 即使跳过了 defconfig，如果索引文件已经被修补，这里应该能通过
          # 如果依然报错，尝试取消下面的注释运行 defconfig
          # make defconfig || true

      - name: Download dependencies
        run: |
          cd openwrt
          make download -j1 V=s

      - name: Compile firmware
        run: |
          cd openwrt
          make -j1 prepare V=s
          make -j$(($(nproc)-2)) V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-firmware
          path: openwrt/bin/targets/ipq60xx/generic/*.bin
          if-no-files-found: warn
