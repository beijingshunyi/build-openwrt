name: Build OpenWrt
run-name: ${{ inputs.device }}

on:
  workflow_dispatch:
    inputs:
      device:
        description: '设备型号'
        required: true
        default: 'jdcloud_ax1800-pro'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TERM: xterm-256color  # 解决终端未知错误

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install full build dependencies (修复终端+递归依赖)
        run: |
          sudo apt update -y
          sudo apt upgrade -y
          # 基础编译依赖 + 终端依赖 + 冲突插件修复依赖
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget \
          ncurses-term libtinfo5 libncursesw5-dev  # 新增终端依赖
          # 清理冲突包
          sudo apt remove -y luci-app-fchomo luci-app-easymesh || true

      - name: Clone ImmortalWrt source (support jdcloud_ax1800-pro)
        run: |
          git clone --depth=1 --branch openwrt-23.05 https://github.com/immortalwrt/immortalwrt.git openwrt
          cp -r files openwrt/ || true
          chmod 755 -R openwrt/files || true
          # 追加PassWall源，避免和系统源冲突
          cat feeds.buildinfo >> openwrt/feeds.conf.default
          # 禁用冲突插件（解决递归依赖）
          echo "CONFIG_PACKAGE_luci-app-fchomo=n" >> openwrt/feeds.conf.default
          echo "CONFIG_PACKAGE_luci-app-easymesh=n" >> openwrt/feeds.conf.default

      - name: Update and install feeds (跳过冲突插件)
        run: |
          cd openwrt
          ./scripts/feeds update -a
          # 安装时排除冲突插件
          ./scripts/feeds install -a -x luci-app-fchomo -x luci-app-easymesh

      - name: Generate device config (无交互+禁用冲突插件)
        run: |
          cd openwrt
          # 清空旧配置
          > .config
          # 写入京东云AX1800 Pro核心配置
          echo "CONFIG_TARGET_ipq60xx=y" >> .config
          echo "CONFIG_TARGET_ipq60xx_generic=y" >> .config
          echo "CONFIG_TARGET_ipq60xx_generic_DEVICE_jdcloud_ax1800-pro=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
          # 禁用递归依赖的插件（核心修复）
          echo "CONFIG_PACKAGE_firewall4=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-fchomo=n" >> .config
          echo "CONFIG_PACKAGE_nikki=n" >> .config
          echo "CONFIG_PACKAGE_luci-app-easymesh=n" >> .config
          echo "CONFIG_PACKAGE_wpad-mesh-openssl=n" >> .config
          echo "CONFIG_PACKAGE_wpad-openssl=y" >> .config  # 替换冲突的wpad
          # 追加PassWall配置
          cat ../config.buildinfo >> .config
          # 直接生成配置，跳过menuconfig交互（解决终端错误）
          make defconfig -j1 V=s

      - name: Download dependencies (无并行，避免依赖冲突)
        run: |
          cd openwrt
          make download -j1 V=s  # 单线程下载，避免依赖包冲突

      - name: Compile firmware (降低并发，避免内存溢出)
        run: |
          cd openwrt
          # 单线程预处理 + 低并发编译
          make -j1 prepare V=s
          make -j$(($(nproc)-2)) V=s

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.device }}-firmware
          path: |
            openwrt/bin/targets/*/*/*.bin
            openwrt/bin/targets/*/*/*.img
          if-no-files-found: warn
